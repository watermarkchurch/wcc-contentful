version: 2.1

executors:
  ruby_2_3:
    docker:
      - image: circleci/ruby:2.3.8-node
        environment:
          POSTGRES_CONNECTION: postgresql://ubuntu:test@127.0.0.1:5432/circle_ruby_test
      - image: postgres:10
        environment:
          POSTGRES_USER: ubuntu
          POSTGRES_PASSWORD: test
          POSTGRES_DB: circle_ruby_test
  ruby_2_5:
    docker:
      - image: circleci/ruby:2.5.7-node
        environment:
          POSTGRES_CONNECTION: postgresql://ubuntu:test@127.0.0.1:5432/circle_ruby_test
      - image: postgres:10
        environment:
          POSTGRES_USER: ubuntu
          POSTGRES_PASSWORD: test
          POSTGRES_DB: circle_ruby_test

jobs:
  test:
    parameters:
      ruby-version:
        type: executor
      gemfile:
        type: string
    executor: << parameters.ruby-version >>
    environment:
      BUNDLE_GEMFILE: << parameters.gemfile >>
      COVERALLS_PARALLEL: true
    steps:
      - checkout
      - run:
          name: Install Gems
          command: |
            bin/use
            bundle install --path /tmp/vendor/bundle
            bin/bundle install --path /tmp/vendor/bundle
      - run:
          name: Run Tests
          command: |
            bin/bundle exec rspec --format documentation --order rand
      
workflows:
  build:
    jobs:
      - test:
          ruby-version: ruby_2_3
          gemfile: gemfiles/rails_5.2_ruby_2.3.8.gemfile


