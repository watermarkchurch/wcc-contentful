<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Documentation by YARD 0.9.28
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "README";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><p><a href="https://rubygems.org/gems/wcc-contentful"><img src="https://badge.fury.io/rb/wcc-contentful.svg" alt="Gem Version"></a>
<a href="https://circleci.com/gh/watermarkchurch/wcc-contentful"><img src="https://circleci.com/gh/watermarkchurch/wcc-contentful.svg?style=svg" alt="Build Status"></a>
<a href="https://coveralls.io/github/watermarkchurch/wcc-contentful?branch=master"><img src="https://coveralls.io/repos/github/watermarkchurch/wcc-contentful/badge.svg?branch=master" alt="Coverage Status"></a></p>

<p>Full documentation: <a href="https://watermarkchurch.github.io/wcc-contentful/latest/wcc-contentful/">https://watermarkchurch.github.io/wcc-contentful/latest/wcc-contentful/</a></p>

<h1 id="wcc-contentful">WCC::Contentful</h1>

<p>An alternative to Contentful&#39;s <a href="https://github.com/contentful/contentful.rb/">contentful.rb ruby client</a>, <a href="https://github.com/contentful/contentful_model">contentful_model</a>, and <a href="https://github.com/contentful/contentful_rails">contentful_rails</a> gems all in one.</p>

<p>Table of Contents:</p>

<ol>
<li><a href="#why-did-you-rewrite-the-contentful-ruby-stack">Why?</a></li>
<li><a href="#installation">Installation</a></li>
<li><a href="#configure">Configuration</a></li>
<li><a href="#usage">Usage</a>

<ol>
<li><a href="#wcccontentfulmodel-api">Model API</a></li>
<li><a href="#store-api">Store API</a></li>
<li><a href="#direct-cdn-api-simpleclient">Direct CDN client</a></li>
<li><a href="#accessing-the-apis-within-application-code">Accessing the APIs</a></li>
</ol></li>
<li><a href="#architecture">Architecture</a>

<ol>
<li><a href="#client-layer">Client Layer</a></li>
<li><a href="#store-layer">Store Layer</a></li>
<li><a href="#model-layer">Model Layer</a></li>
</ol></li>
<li><a href="#test-helpers">Test Helpers</a></li>
<li><a href="#advanced-configuration-example">Advanced Configuration Example</a></li>
<li><a href="#connecting-to-multiple-spaces-or-environments">Connecting to Multiple Spaces</a></li>
<li><a href="#development">Development</a></li>
<li><a href="#contributing">Contributing</a></li>
<li><a href="#license">License</a></li>
</ol>

<h2 id="why-did-you-rewrite-the-contentful-ruby-stack">Why did you rewrite the Contentful ruby stack?</h2>

<p>We started working with Contentful almost 5 years ago.  Since that time, Contentful&#39;s ruby stack has improved, but there are still a number of pain points that we feel we have addressed better with our gem.  These are:</p>

<ul>
<li><a href="#low-level-caching">Low-level caching</a></li>
<li><a href="#better-rails-integration">Better integration with Rails &amp; Rails models</a></li>
<li><a href="#automatic-pagination-and-link-resolution">Automatic pagination and Automatic link resolution</a></li>
<li><a href="#automatic-webhook-management">Automatic webhook management</a></li>
</ul>

<p>Our gem no longer depends on any of the Contentful gems and interacts directly with the <a href="https://www.contentful.com/developers/docs/references/content-delivery-api/">Contentful CDA</a> and <a href="https://www.contentful.com/developers/docs/references/content-management-api/">Content Management API</a> over HTTPS.</p>

<h3 id="low-level-caching">Low-level caching</h3>

<p>The wcc-contentful gem enables caching at two levels: the HTTP response using <a href="https://github.com/sourcelevel/faraday-http-cache">Faraday HTTP cache middleware</a>, and at the Entry level using the Rails cache and the <a href="https://www.contentful.com/developers/docs/references/content-delivery-api/#/reference/synchronization">Sync API</a> to keep it up to date.  We&#39;ve found these two cache layers to be very effective at reducing both round trip latency to the Content Delivery API, as well as reducing our monthly API request usage. (which reduces our overage charges.  Hooray!)</p>

<h4 id="at-the-request-response-level">At the request/response level</h4>

<p>By default, the contentful.rb gem requires the <a href="https://rubygems.org/gems/http">HTTP library</a>.  While simple and straightforward to use, it is not as powerful for caching.  We decided to make our client conform to the <a href="https://github.com/lostisland/faraday">Faraday gem&#39;s API</a>.  If you prefer not to use Faraday, you can choose to supply your own HTTP adapter that &quot;quacks like&quot; Faraday (see the <a href="https://github.com/watermarkchurch/wcc-contentful/blob/master/wcc-contentful/lib/wcc/contentful/simple_client/typhoeus_adapter.rb">TyphoeusAdapter</a> for one implementation).</p>

<p>Using Faraday makes it easy to add Middleware.  As an example, our flagship Rails app that powers watermark.org uses the following configuration in Production, which provides us with instrumentation through statsd, logging, and caching:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_connection'>connection</span> <span class='op'>=</span> <span class='const'>Faraday</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_builder'>builder</span><span class='op'>|</span>
  <span class='id identifier rubyid_builder'>builder</span><span class='period'>.</span><span class='id identifier rubyid_use'>use</span> <span class='symbol'>:http_cache</span><span class='comma'>,</span>
    <span class='label'>shared_cache:</span> <span class='kw'>false</span><span class='comma'>,</span>
    <span class='label'>store:</span> <span class='const'>ActiveSupport</span><span class='op'>::</span><span class='const'>Cache</span><span class='op'>::</span><span class='const'>MemoryStore</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='label'>size:</span> <span class='int'>512</span><span class='period'>.</span><span class='id identifier rubyid_megabytes'>megabytes</span><span class='rparen'>)</span><span class='comma'>,</span>
    <span class='label'>logger:</span> <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='comma'>,</span>
    <span class='label'>serializer:</span> <span class='const'>Marshal</span><span class='comma'>,</span>
    <span class='label'>instrumenter:</span> <span class='const'>ActiveSupport</span><span class='op'>::</span><span class='const'>Notifications</span>

  <span class='id identifier rubyid_builder'>builder</span><span class='period'>.</span><span class='id identifier rubyid_use'>use</span> <span class='symbol'>:gzip</span>
  <span class='id identifier rubyid_builder'>builder</span><span class='period'>.</span><span class='id identifier rubyid_response'>response</span> <span class='symbol'>:logger</span><span class='comma'>,</span> <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span><span class='comma'>,</span> <span class='label'>headers:</span> <span class='kw'>false</span><span class='comma'>,</span> <span class='label'>bodies:</span> <span class='kw'>false</span> <span class='kw'>if</span> <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_env'>env</span><span class='period'>.</span><span class='id identifier rubyid_development?'>development?</span>
  <span class='id identifier rubyid_builder'>builder</span><span class='period'>.</span><span class='id identifier rubyid_request'>request</span> <span class='symbol'>:instrumentation</span>
  <span class='id identifier rubyid_builder'>builder</span><span class='period'>.</span><span class='id identifier rubyid_adapter'>adapter</span> <span class='symbol'>:typhoeus</span>
<span class='kw'>end</span>
</code></pre>

<h4 id="at-the-entry-level">At the Entry level</h4>

<p>Our stack has three layers, the middle layer being essentially a cache for individual Entry hashes parsed out of responses from the Delivery API.  We were able to add a caching layer here which stores entries retrieved over the Sync API, and responds to queries with cached versions of local content when possible.  We consider this to be our best innovation on the Contentful ruby stack.</p>

<p>We have successfully created caching layers using Memcached, Postgres, and an in-memory hash.  The architecture allows other caching implementations to be created fairly easily, and we have a set of rspec specs that can verify that a cache store behaves appropriately.  For more information, <a href="https://watermarkchurch.github.io/wcc-contentful/latest/wcc-contentful/WCC/Contentful/Store.html">see the documentation on the caching modes here</a>.</p>

<h3 id="better-rails-integration">Better Rails Integration</h3>

<p>When we initially got started with the Contentful ruby models, we encountered one problem that was more frustrating than all others: If a field exists in the content model, but the particular entry we&#39;re working with does not have that field populated, then accessing that field raised a <code>NoMethodError</code>.  This caused us to litter our code with <code>if defined?(entry.my_field)</code> which is bad practice.  (Note: this has since been fixed in contentful.rb v2).</p>

<p>We decided it was better to not rely on <code>method_missing?</code> (what contentful.rb does), and instead to use <code>define_method</code> in an initializer to generate the methods for our models.  This has the advantage that calling <code>.instance_methods</code> on a model class includes all the fields present in the content model.</p>

<p>We also took advantage of Rails&#39; naming conventions to automatically infer the content type name based on the class name.  Thus in our code, we have <code>app/models/page.rb</code> which defines <code>class Page &lt;&lt; WCC::Contentful::Model::Page</code>, and is automatically linked to the <code>page</code> content type ID.  (Note: this is overridable on a per-model basis)</p>

<p>All our models are automatically generated at startup which improves response times at the expense of initialization time.  In addition, our content model registry allows easy definition of custom models in your <code>app/models</code> directory to override fields.  This plays nice with other gems like algoliasearch-rails, which allows you to declaratively manage your Algolia indexes.  Another example from our flagship watermark.org:</p>

<pre class="code ruby"><code class="ruby">class Page &lt; WCC::Contentful::Model::Page
  include AlgoliaSearch

  algoliasearch(index_name: &#39;pages&#39;) do
    attribute(:title, :slug)
    ...
  end
</code></pre>

<h3 id="automatic-pagination-and-link-resolution">Automatic Pagination and Link Resolution</h3>

<p>Using the <code>contentful_model</code> gem, calling <code>Page.all.load</code> does not give you all Page entries if there are more than 100.  To get the next page you must call <code>.paginate</code> on the response.  By contrast, <code>Page.find_all</code> in the <code>wcc-contentful</code> gem gives you a <a href="https://ruby-doc.org/core-2.5.0/Enumerator/Lazy.html">Lazy Enumerator</a>.  As you iterate past the 100th entry, the enumerator will automatically fetch the next page.  If you only enumerate 99 entries (say with <code>.take(99)</code>), then the second page will never be fetched.</p>

<p>Similarly, if your Page references an asset, say <code>hero_image</code>, that field returns a <code>Link</code> object rather than the actual <code>Asset</code>.  You must either predefine how many links you need using <code>Page.load_children(3).all.load</code>, or detect that <code>hero_image</code> is a <code>Link</code> like <code>if @page.hero_image.is_a? Contentful::Link</code> and then call <code>.resolve</code> on the link.  We found all of that to be too cumbersome when we are down in a nested partial view template that may be invoked from multiple places.</p>

<p>The <code>wcc-contentful</code> gem, by contrast, automatically resolves a link when accessing the associated attribute.  So in our example above, <code>wcc-contentful</code> will <strong>always</strong> return a <code>WCC::Contentful::Asset</code> when calling <code>@page.hero_image</code>, even if it has to execute a query to cdn.contentful.com in order to fetch it.</p>

<p>Warning: This can easily lead to you exhausting your Contentful API quota if you do not carefully tune your cache, which you should be doing anyways!  The default settings will use the Rails cache to try to cache these resolutions, but <em>you are ultimately responsible for how many queries you execute!</em></p>

<h3 id="automatic-webhook-management">Automatic webhook management</h3>

<p>The <code>wcc-contentful</code> gem, just like <code>contentful_rails</code>, provides an Engine to be mounted in your Rails routes file.  Unlike <code>contentful_rails</code>, if you also configure <code>wcc-contentful</code> with a Contentful Management Token and a public <code>app_url</code>, then on startup the <code>wcc-contentful</code> engine will reach out to the Contentful Management API and ensure that a webhook is configured to point to your app.  This is one less devops burden on you, and plays very nicely in with Heroku review apps.</p>

<h2 id="installation">Installation</h2>

<p>Add this line to your application&#39;s Gemfile:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>wcc-contentful</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>require:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>wcc/contentful/rails</span><span class='tstring_end'>&#39;</span></span>
</code></pre>

<p>If you&#39;re not using rails, exclude the <code>require:</code> parameter.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>wcc-contentful</span><span class='tstring_end'>&#39;</span></span>
</code></pre>

<p>And then execute:</p>

<pre class="code ruby"><code class="ruby">$ bundle
</code></pre>

<p>Or install it yourself:</p>

<pre class="code ruby"><code class="ruby">$ gem install wcc-contentful
</code></pre>

<h2 id="configure">Configure</h2>

<p>Put this in an initializer:</p>

<pre class="code ruby"><code class="ruby"># config/initializers/wcc_contentful.rb
WCC::Contentful.configure do |config|
  config.access_token = &lt;CONTENTFUL_ACCESS_TOKEN&gt;
  config.space = &lt;CONTENTFUL_SPACE_ID&gt;
end

WCC::Contentful.init!
</code></pre>

<p>All configuration options can be found <a href="https://watermarkchurch.github.io/wcc-contentful/latest/wcc-contentful/WCC/Contentful/Configuration">in the rubydoc under
WCC::Contentful::Configuration</a> </p>

<h2 id="usage">Usage</h2>

<h3 id="wcc-contentful-model-api">WCC::Contentful::Model API</h3>

<p>The WCC::Contentful::Model API exposes Contentful data as a set of dynamically
generated Ruby objects.  These objects are based on the content types in your
Contentful space.  All these objects are generated by <code>WCC::Contentful.init!</code></p>

<p>The following examples show how to use this API to find entries of the <code>page</code>
content type:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/page.rb
</span><span class='kw'>class</span> <span class='const'>Page</span> <span class='op'>&lt;</span> <span class='const'><span class='object_link'><a href="WCC.html" title="WCC (module)">WCC</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful.html" title="WCC::Contentful (module)">Contentful</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful/Model.html" title="WCC::Contentful::Model (class)">Model</a></span></span><span class='op'>::</span><span class='const'>Page</span>

  <span class='comment'># You can add additional methods here
</span><span class='kw'>end</span>

<span class='comment'># Find objects by id
</span><span class='const'>Page</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1E2ucWSdacxxf233sfa3</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='comment'># =&gt; #&lt;Page:0x0000000005c71a78 @created_at=2018-04-16 18:41:17 UTC...&gt;
</span>
<span class='comment'># Find objects by field
</span><span class='const'>Page</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>slug:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/some-slug</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='comment'># =&gt; #&lt;Page:0x0000000005c71a78 @created_at=2018-04-16 18:41:17 UTC...&gt;
</span>
<span class='comment'># Use operators to filter by a field
</span><span class='comment'># must use full notation for sys attributes (except ID)
</span><span class='const'>Page</span><span class='period'>.</span><span class='id identifier rubyid_find_all'>find_all</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sys.created_at</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>lte:</span> <span class='const'>Date</span><span class='period'>.</span><span class='id identifier rubyid_today'>today</span> <span class='rbrace'>}</span><span class='rparen'>)</span>
<span class='comment'># =&gt; [#&lt;Page:0x0000000005c71a78 @created_at=2018-04-16 18:41:17 UTC...&gt;, ... ]
</span>
<span class='comment'># Nest queries to mimick joins
</span><span class='const'>Page</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>subpages:</span> <span class='lbrace'>{</span> <span class='label'>slug:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/some-slug</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span><span class='rparen'>)</span>
<span class='comment'># =&gt; #&lt;Page:0x0000000005c71a78 @created_at=2018-04-16 18:41:17 UTC...&gt;
</span>
<span class='comment'># Fetch an entry in a different locale
</span><span class='id identifier rubyid_spanish_homepage'>spanish_homepage</span> <span class='op'>=</span> <span class='const'>Page</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>slug:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>options:</span> <span class='lbrace'>{</span> <span class='label'>locale:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>es-US</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span><span class='rparen'>)</span>
<span class='comment'># =&gt; #&lt;Page:0x0000000005c71a78 @created_at=2018-04-16 18:41:17 UTC...&gt;
</span><span class='id identifier rubyid_spanish_homepage'>spanish_homepage</span><span class='period'>.</span><span class='id identifier rubyid_title'>title</span>
<span class='comment'># =&gt; Esta es la página principal
</span>
<span class='comment'># Pass the preview flag to use the preview client (must have set preview_token config param)
</span><span class='id identifier rubyid_preview_redirect'>preview_redirect</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="WCC.html" title="WCC (module)">WCC</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful.html" title="WCC::Contentful (module)">Contentful</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful/Model.html" title="WCC::Contentful::Model (class)">Model</a></span></span><span class='op'>::</span><span class='const'>Redirect</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='label'>slug:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>draft-redirect</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span><span class='comma'>,</span> <span class='label'>preview:</span> <span class='kw'>true</span><span class='rparen'>)</span>
<span class='comment'># =&gt; #&lt;WCC::Contentful::Model::Redirect:0x0000000005d879ad @created_at=2018-04-16 18:41:17 UTC...&gt;
</span><span class='id identifier rubyid_preview_redirect_object'>preview_redirect_object</span><span class='period'>.</span><span class='id identifier rubyid_href'>href</span>
<span class='comment'># =&gt; &#39;http://www.somesite.com/slug-for-redirect&#39;
</span></code></pre>

<p>See the <span class='object_link'><a href="WCC/Contentful/Model.html" title="WCC::Contentful::Model (class)">WCC::Contentful::Model</a></span> documentation for more details.</p>

<h3 id="store-api">Store API</h3>

<p>The Store layer is used by the Model API to access Contentful data in a raw form.
The Store layer returns entries as hashes parsed from JSON, conforming to the
object structure returned from the Contentful CDN.</p>

<p>The following examples show how to use the Store API to retrieve raw data from
the store:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_store'>store</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="WCC.html" title="WCC (module)">WCC</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful.html" title="WCC::Contentful (module)">Contentful</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful/Services.html" title="WCC::Contentful::Services (class)">Services</a></span></span><span class='period'>.</span><span class='id identifier rubyid_instance'><span class='object_link'><a href="WCC/Contentful/Services.html#instance-class_method" title="WCC::Contentful::Services.instance (method)">instance</a></span></span><span class='period'>.</span><span class='id identifier rubyid_store'>store</span>
<span class='comment'># =&gt; #&lt;WCC::Contentful::Store::CDNAdapter:0x00007fb92a221498
</span>
<span class='id identifier rubyid_store'>store</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>5FsqsbMECsM62e04U8sY4Y</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='comment'># =&gt; {&quot;sys&quot;=&gt;
</span><span class='comment'>#  ...
</span><span class='comment'># &quot;fields&quot;=&gt;
</span><span class='comment'># ...}
</span>
<span class='id identifier rubyid_store'>store</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>content_type:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>page</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>filter:</span> <span class='lbrace'>{</span> <span class='label'>slug:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/some-slug</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span><span class='rparen'>)</span>
<span class='comment'># =&gt; {&quot;sys&quot;=&gt;
</span><span class='comment'>#  ...
</span><span class='comment'># &quot;fields&quot;=&gt;
</span><span class='comment'># ...}
</span>
<span class='id identifier rubyid_query'>query</span> <span class='op'>=</span> <span class='id identifier rubyid_store'>store</span><span class='period'>.</span><span class='id identifier rubyid_find_all'>find_all</span><span class='lparen'>(</span><span class='label'>content_type:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>page</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_eq'>eq</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>group</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>some-group</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='comment'># =&gt; #&lt;WCC::Contentful::Store::CDNAdapter::Query:0x00007fa3d40b84f0
</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
<span class='comment'># =&gt; {&quot;sys&quot;=&gt;
</span><span class='comment'>#  ...
</span><span class='comment'># &quot;fields&quot;=&gt;
</span><span class='comment'># ...}
</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_result'>result</span>
<span class='comment'># =&gt; #&lt;Enumerator::Lazy: ...&gt;
</span><span class='id identifier rubyid_query'>query</span><span class='period'>.</span><span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_force'>force</span>
<span class='comment'># =&gt; [{&quot;sys&quot;=&gt; ...}, {&quot;sys&quot;=&gt; ...}, ...]
</span></code></pre>

<p>The store layer, while superficially similar to the Contentful API, tries to present a different &quot;View&quot; over the data
which is more compatible with the Model layer.  It resolves includes by actually replacing the in-memory <code>Link</code> objects
with their linked <code>Entry</code> representations.  This lets you traverse the links naturally using <code>#dig</code> or <code>#[]</code>:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># Include to a depth of 3 to make sure it&#39;s included
</span><span class='id identifier rubyid_homepage'>homepage</span> <span class='op'>=</span> <span class='id identifier rubyid_store'>store</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>slug:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>include:</span> <span class='int'>3</span><span class='rparen'>)</span>
<span class='comment'># Traverse through the top nav menu =&gt; menu button 0 =&gt; about page
</span><span class='id identifier rubyid_about_page'>about_page</span> <span class='op'>=</span> <span class='id identifier rubyid_homepage'>homepage</span><span class='period'>.</span><span class='id identifier rubyid_dig'>dig</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fields</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>nav_menu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fields</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>buttons</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='int'>0</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fields</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>page</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
</code></pre>

<p>See the <span class='object_link'><a href="WCC/Contentful/Store.html" title="WCC::Contentful::Store (module)">WCC::Contentful::Store</a></span> documentation for more details.</p>

<h3 id="direct-cdn-api-simpleclient">Direct CDN API (SimpleClient)</h3>

<p>The SimpleClient is the bottom layer, and is used to get raw data directly from
the Contentful CDN.  It handles response parsing and paging, but does not resolve
links or transform the result into a Model class.</p>

<p>The following examples show how to use the SimpleClient to retrieve data directly
from the Contentful CDN:</p>

<pre class="code ruby"><code class="ruby">client = WCC::Contentful::Services.instance.client
# =&gt; #&lt;WCC::Contentful::SimpleClient::Cdn:0x00007fa3cde89310

response = client.entry(&#39;5FsqsbMECsM62e04U8sY4Y&#39;)
# =&gt; #&lt;WCC::Contentful::SimpleClient::Response:0x00007fa3d103a4e0
response.body
# =&gt; &quot;{\n  \&quot;sys\&quot;: {\n ...
response.raw
# =&gt; {&quot;sys&quot;=&gt;
#  ...
# &quot;fields&quot;=&gt;
# ...}

client.asset(&#39;5FsqsbMECsM62e04U8sY4Y&#39;).raw
# =&gt; {&quot;sys&quot;=&gt;
#  ...
# &quot;fields&quot;=&gt;
# ...}

response = client.entries(&#39;fields.group&#39; =&gt; &#39;some-group&#39;, &#39;limit&#39; =&gt; 5)
# =&gt; #&lt;WCC::Contentful::SimpleClient::Response:0x00007fa3d103a4e0
response.count
# =&gt; 99
response.first
# =&gt; {&quot;sys&quot;=&gt;
#  ...
# &quot;fields&quot;=&gt;
# ...}
response.items
=&gt; #&lt;Enumerator::Lazy: ...&gt;
response.items.count  # Careful! This evaluates the lazy iterator and gets all pages
# =&gt; 99

response.includes
# =&gt; {&quot;4xNnFJ77egkSMEogE2yISa&quot;=&gt;
#   {&quot;sys&quot;=&gt; ...}
#  &quot;6Fwukxxkxa6qQCC04WCaqg&quot;=&gt;
#   {&quot;sys&quot;=&gt; ...}
#   ...}
</code></pre>

<p>The client handles Paging automatically within the lazy iterator returned by #items.
This lazy iterator does not respect the <code>limit</code> param - that param is only passed
through to the API to set the page size.  If you truly want a limited subset of
response items, use <a href="https://ruby-doc.org/core-2.5.3/Enumerable.html#method-i-take"><code>response.items.take(n)</code></a></p>

<p>Entries included via the <code>include</code> parameter are made available on the #includes
field.  This is a hash of <code>&lt;entry ID&gt; =&gt; &lt;raw entry&gt;</code> and makes it easy to grab
links.  This hash is added to lazily as you enumerate the pages.</p>

<p>See the <span class='object_link'><a href="WCC/Contentful/SimpleClient.html" title="WCC::Contentful::SimpleClient (class)">WCC::Contentful::SimpleClient</a></span> documentation for more details.</p>

<h3 id="accessing-the-apis-within-application-code">Accessing the APIs within application code</h3>

<p>The Model API is best exposed by defining your own model classes in the <code>app/models</code>
directory which inherit from the WCC::Contentful models.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># app/models/page.rb
</span><span class='kw'>class</span> <span class='const'>Page</span> <span class='op'>&lt;</span> <span class='const'><span class='object_link'><a href="WCC.html" title="WCC (module)">WCC</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful.html" title="WCC::Contentful (module)">Contentful</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful/Model.html" title="WCC::Contentful::Model (class)">Model</a></span></span><span class='op'>::</span><span class='const'>Page</span>

  <span class='comment'># You can add additional methods here
</span><span class='kw'>end</span>

<span class='comment'># app/controllers/pages_controller.rb
</span><span class='kw'>class</span> <span class='const'>PagesController</span> <span class='op'>&lt;</span> <span class='const'>ApplicationController</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_show'>show</span>
    <span class='ivar'>@page</span> <span class='op'>=</span> <span class='const'>Page</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>slug:</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:slug</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>Exceptions</span><span class='op'>::</span><span class='const'>PageNotFoundError</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:slug</span><span class='rbracket'>]</span> <span class='kw'>unless</span> <span class='ivar'>@page</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>The <span class='object_link'><a href="WCC/Contentful/Services.html" title="WCC::Contentful::Services (class)">WCC::Contentful::Services</a></span> singleton gives access to the other configured services.
You can also include the <span class='object_link'><a href="WCC/Contentful/ServiceAccessors.html" title="WCC::Contentful::ServiceAccessors (module)">WCC::Contentful::ServiceAccessors</a></span> concern to define these
services as attributes in a class.</p>

<pre class="code ruby"><code class="ruby">class MyJob &lt; ApplicationJob
  include WCC::Contentful::ServiceAccessors

  def perform
    Page.find(...)

    store.find(...)

    client.entries(...)
  end
end
</code></pre>

<h2 id="architecture">Architecture</h2>

<p><img src="./doc-static/wcc-contentful.png" alt="wcc-contentful diagram"></p>

<p>From the bottom up:</p>

<h3 id="client-layer">Client Layer</h3>

<p>The <span class='object_link'><a href="WCC/Contentful/SimpleClient.html" title="WCC::Contentful::SimpleClient (class)">WCC::Contentful::SimpleClient</a></span> provides methods to access the <a href="https://www.contentful.com/developers/docs/references/content-delivery-api/">Contentful 
Content Delivery API</a>
through your favorite HTTP client gem.  The SimpleClient expects
an Adapter that conforms to the Faraday interface.</p>

<p>Creating a SimpleClient to connect using different credentials, or to connect
without setting up all the rest of WCC::Contentful, is easy:</p>

<pre class="code ruby"><code class="ruby">WCC::Contentful::SimpleClient::Cdn.new(
  # required
  access_token: &#39;xxxx&#39;,
  space: &#39;1234&#39;,
  # optional
  environment: &#39;staging&#39;, # omit to use master
  default_locale: &#39;*&#39;,
  rate_limit_wait_timeout: 10,
  instrumentation: ActiveSupport::Notifications,
  connection: Faraday.new { |builder| ... },
)
</code></pre>

<p>You can also create a <span class='object_link'><a href="WCC/Contentful/SimpleClient/Preview.html" title="WCC::Contentful::SimpleClient::Preview (class)">WCC::Contentful::SimpleClient::Preview</a></span> to talk to the
Preview API, or a <span class='object_link'><a href="WCC/Contentful/SimpleClient/Management.html" title="WCC::Contentful::SimpleClient::Management (class)">WCC::Contentful::SimpleClient::Management</a></span> to talk to the
Management API.</p>

<h3 id="store-layer">Store Layer</h3>

<p>The Store Layer represents the data store where Contentful entries are kept for
querying.  By default, <code>WCC::Contentful.init!</code> creates a <span class='object_link'><a href="WCC/Contentful/Store/CDNAdapter.html" title="WCC::Contentful::Store::CDNAdapter (class)">WCC::Contentful::Store::CDNAdapter</a></span>
which uses a <span class='object_link'><a href="WCC/Contentful/SimpleClient/Cdn.html" title="WCC::Contentful::SimpleClient::Cdn (class)">WCC::Contentful::SimpleClient::Cdn</a></span> instance to query entries from
the <a href="https://www.contentful.com/developers/docs/references/content-delivery-api/">Contentful Content Delivery API</a>.  You can also query entries from another
source like Postgres or an in-memory hash if your data is small enough.</p>

<p>You can also implement your own store if you want!  The gem contains a suite of
RSpec shared examples that give you a baseline for implementing your own store.
In your RSpec suite:</p>

<pre class="code ruby"><code class="ruby"># frozen_string_literal: true

require &#39;my_store&#39;
require &#39;wcc/contentful/store/rspec_examples&#39;

RSpec.describe MyStore do
  it_behaves_like &#39;contentful store&#39;, {
    # Set which store features your store implements.  
    nested_queries: true,  # Does your store implement JOINs?
    include_param: true    # Does your store resolve links when given the :include option?
  }
</code></pre>

<p>The store is kept up-to-date by the <span class='object_link'><a href="WCC/Contentful/SyncEngine.html" title="WCC::Contentful::SyncEngine (class)">WCC::Contentful::SyncEngine</a></span>.  The <code>SyncEngine#next</code> methodcalls the <code>#index</code> method on the configured store in order to update
it with the latest data via the <a href="https://www.contentful.com/developers/docs/references/content-delivery-api/#/reference/synchronization">Contentful Sync API</a>.  For example,
the <span class='object_link'><a href="WCC/Contentful/Store/MemoryStore.html" title="WCC::Contentful::Store::MemoryStore (class)">WCC::Contentful::Store::MemoryStore</a></span> uses this to update the hash with the
newest version of an entry, or delete an entry out of the hash.</p>

<h4 id="store-middleware">Store Middleware</h4>

<p>The store layer is made up of a base store (which implements <span class='object_link'><a href="WCC/Contentful/Store/Interface.html" title="WCC::Contentful::Store::Interface (module)">WCC::Contentful::Store::Interface</a></span>),
and some required middleware.  The list of default middleware applied to each store is found in
<span class='object_link'><a href="WCC/Contentful/Store/Factory.html#default_middleware-class_method" title="WCC::Contentful::Store::Factory.default_middleware (method)">WCC::Contentful::Store::Factory.default_middleware</a></span></p>

<p>To create your own middleware simply include <span class='object_link'><a href="WCC/Contentful/Middleware/Store.html" title="WCC::Contentful::Middleware::Store (module)">WCC::Contentful::Middleware::Store</a></span>.  Then you can optionally implement
the <code>#transform</code> and <code>#select?</code> methods:</p>

<pre class="code ruby"><code class="ruby"><span class='kw'>class</span> <span class='const'>MyMiddleware</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="WCC.html" title="WCC (module)">WCC</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful.html" title="WCC::Contentful (module)">Contentful</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful/Middleware.html" title="WCC::Contentful::Middleware (module)">Middleware</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful/Middleware/Store.html" title="WCC::Contentful::Middleware::Store (module)">Store</a></span></span>

  <span class='comment'># Called for each entry that is requested out of the backing store.  You can modify the entry and return it to the
</span>  <span class='comment'># next layer.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_transform'>transform</span><span class='lparen'>(</span><span class='id identifier rubyid_entry'>entry</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span>
    <span class='comment'># Do something with the entry...
</span>    <span class='comment'># Make sure you return it at the end!
</span>    <span class='id identifier rubyid_entry'>entry</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_select?'>select?</span><span class='lparen'>(</span><span class='id identifier rubyid_entry'>entry</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span>
    <span class='comment'># Choose whether this entry should exist or not.  If you return false here, then the entry will act as though it
</span>    <span class='comment'># were archived in Contentful.
</span>    <span class='id identifier rubyid_entry'>entry</span><span class='period'>.</span><span class='id identifier rubyid_dig'>dig</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>fields</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hide_until</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='op'>&gt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_zone'>zone</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>You can also override any of the standard Store methods.</p>

<p>To apply the middleware, call <code>use</code> when configuring the store:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_store'>store</span> <span class='symbol'>:direct</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_use'>use</span> <span class='const'>MyMiddleware</span><span class='comma'>,</span> <span class='label'>param1:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>xxx</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>The most useful middleware is the <span class='object_link'><a href="WCC/Contentful/Middleware/Store/CachingMiddleware.html" title="WCC::Contentful::Middleware::Store::CachingMiddleware (class)">WCC::Contentful::Middleware::Store::CachingMiddleware</a></span>,
which enables <code>:lazy_sync</code> mode (see <span class='object_link'><a href="WCC/Contentful/Configuration.html#store-instance_method" title="WCC::Contentful::Configuration#store (method)">WCC::Contentful::Configuration#store</a></span>)</p>

<h3 id="model-layer">Model Layer</h3>

<p>This is the global top layer where your Rails app looks up content similarly to
ActiveModel.  The models are namespaced under the root class <span class='object_link'><a href="WCC/Contentful/Model.html" title="WCC::Contentful::Model (class)">WCC::Contentful::Model</a></span>.
Each model&#39;s implementation of <code>.find</code>, <code>.find_by</code>, and <code>.find_all</code> simply call
into the configured Store.</p>

<p>Models can be initialized directly with the <code>.new</code> method, by passing in a hash:</p>

<pre class="code ruby"><code class="ruby">entry = { &#39;sys&#39; =&gt; ..., &#39;fields&#39; =&gt; ... }
Page.new(entry)
</code></pre>

<p><strong>The initializer must receive a localized entry</strong>.  An entry found using a <code>locale=*</code> query
must be transformed to a localized entry using the <span class='object_link'><a href="WCC/Contentful/EntryLocaleTransformer.html" title="WCC::Contentful::EntryLocaleTransformer (module)">WCC::Contentful::EntryLocaleTransformer</a></span> before
passing it to your model:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_entry'>entry</span> <span class='op'>=</span> <span class='id identifier rubyid_client'>client</span><span class='period'>.</span><span class='id identifier rubyid_entry'>entry</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1234</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>locale:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>*</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_raw'>raw</span>
<span class='id identifier rubyid_localized_entry'>localized_entry</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="WCC.html" title="WCC (module)">WCC</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful.html" title="WCC::Contentful (module)">Contentful</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful/EntryLocaleTransformer.html" title="WCC::Contentful::EntryLocaleTransformer (module)">EntryLocaleTransformer</a></span></span><span class='period'>.</span><span class='id identifier rubyid_transform_to_locale'><span class='object_link'><a href="WCC/Contentful/EntryLocaleTransformer.html#transform_to_locale-instance_method" title="WCC::Contentful::EntryLocaleTransformer#transform_to_locale (method)">transform_to_locale</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_entry'>entry</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>en-US</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='const'>Page</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_localized_entry'>localized_entry</span><span class='rparen'>)</span>
</code></pre>

<p>The Store layer ensures that localized entries are returned using the <span class='object_link'><a href="WCC/Contentful/Middleware/Store/LocaleMiddleware.html" title="WCC::Contentful::Middleware::Store::LocaleMiddleware (class)">WCC::Contentful::Middleware::Store::LocaleMiddleware</a></span>.</p>

<p>The main benefit of the Model layer is lazy link resolution.  When a model&#39;s
property is accessed, if that property is a link that has not been resolved
yet (for example using the <code>include: n</code> parameter on <code>.find_by</code>), the model
will automatically call <code>#find</code> on the store to resolve that linked entry.</p>

<p>Note that this can easily result in lots of CDN calls to Contentful!  To optimize
this you should use the <code>include</code> parameter and/or use a different store.</p>

<h2 id="test-helpers">Test Helpers</h2>

<p>To use the test helpers, include the following in your rails_helper.rb:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>wcc/contentful/rspec</span><span class='tstring_end'>&#39;</span></span>
</code></pre>

<p>This adds the following helpers to all your specs:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'>##
</span><span class='comment'># Builds a in-memory instance of the Contentful model for the given content_type.
</span><span class='comment'># All attributes that are known to be required fields on the content type
</span><span class='comment'># will return a default value based on the field type.
</span><span class='id identifier rubyid_instance'>instance</span> <span class='op'>=</span> <span class='id identifier rubyid_contentful_create'>contentful_create</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>my-content-type</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>my_field:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>some-value</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='comment'># =&gt; #&lt;WCC::Contentful::Model::MyContentType:0x0000000005c71a78 @created_at=2018-04-16 18:41:17 UTC...&gt;
</span>
<span class='id identifier rubyid_instance'>instance</span><span class='period'>.</span><span class='id identifier rubyid_my_field'>my_field</span>
<span class='comment'># =&gt; &quot;some-value&quot;
</span>
<span class='id identifier rubyid_instance'>instance</span><span class='period'>.</span><span class='id identifier rubyid_other_required_field'>other_required_field</span>
<span class='comment'># =&gt; &quot;default-value&quot;
</span>
<span class='id identifier rubyid_instance'>instance</span><span class='period'>.</span><span class='id identifier rubyid_other_optional_field'>other_optional_field</span>
<span class='comment'># =&gt; nil
</span>
<span class='id identifier rubyid_instance'>instance</span><span class='period'>.</span><span class='id identifier rubyid_not_a_field'>not_a_field</span>
<span class='comment'># NoMethodError: undefined method `not_a_field&#39; for #&lt;MyContentType:0x00007fbac81ee490&gt;
</span>
<span class='comment'>##
</span><span class='comment'># Builds a rspec double of the Contentful model for the given content_type.
</span><span class='comment'># All attributes that are known to be required fields on the content type
</span><span class='comment'># will return a default value based on the field type.
</span><span class='id identifier rubyid_dbl'>dbl</span> <span class='op'>=</span> <span class='id identifier rubyid_contentful_double'>contentful_double</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>my-content-type</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>my_field:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>other-value</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='comment'># =&gt; #&lt;Double (anonymous)&gt;
</span>
<span class='id identifier rubyid_dbl'>dbl</span><span class='period'>.</span><span class='id identifier rubyid_my_field'>my_field</span>
<span class='comment'># =&gt; &quot;other-value&quot;
</span>
<span class='id identifier rubyid_dbl'>dbl</span><span class='period'>.</span><span class='id identifier rubyid_other_optional_field'>other_optional_field</span>
<span class='comment'># =&gt; nil
</span>
<span class='id identifier rubyid_dbl'>dbl</span><span class='period'>.</span><span class='id identifier rubyid_not_a_field'>not_a_field</span>
<span class='comment'># =&gt; #&lt;Double (anonymous)&gt; received unexpected message :not_a_field with (no args)
</span>
<span class='comment'>##
</span><span class='comment'># Builds out a fake Contentful entry for the given content type, and then
</span><span class='comment'># stubs the Model API to return that content type for `.find` and `.find_by`
</span><span class='comment'># query methods.
</span><span class='id identifier rubyid_stubbed'>stubbed</span> <span class='op'>=</span> <span class='id identifier rubyid_contentful_stub'>contentful_stub</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>my-content-type</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>id:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1234</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>my_field:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>test</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

<span class='const'><span class='object_link'><a href="WCC.html" title="WCC (module)">WCC</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful.html" title="WCC::Contentful (module)">Contentful</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful/Model.html" title="WCC::Contentful::Model (class)">Model</a></span></span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1234</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='op'>==</span> <span class='id identifier rubyid_stubbed'>stubbed</span>
<span class='comment'># =&gt; true
</span>
<span class='const'>MyContentType</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1234</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='op'>==</span> <span class='id identifier rubyid_stubbed'>stubbed</span>
<span class='comment'># =&gt; true
</span>
<span class='const'>MyContentType</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>my_field:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>test</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='op'>==</span> <span class='id identifier rubyid_stubbed'>stubbed</span>
<span class='comment'># =&gt; true
</span></code></pre>

<h2 id="advanced-configuration-example">Advanced Configuration Example</h2>

<p>Here&#39;s an example containing all the configuration options, and a sample setup for
automatic deployment to Heroku.  This is intended to make you aware of what is possible,
and not as a general recommendation of what your setup should look like.</p>

<pre class="code ruby"><code class="ruby"># config/initializers/wcc_contentful.rb
WCC::Contentful.configure do |config|
  config.access_token = ENV[&#39;CONTENTFUL_ACCESS_TOKEN&#39;]
  config.space = ENV[&#39;CONTENTFUL_SPACE_ID&#39;]
  config.environment = ENV[&#39;CONTENTFUL_ENVIRONMENT&#39;]
  config.preview_token = ENV[&#39;CONTENTFUL_PREVIEW_ACCESS_TOKEN&#39;]

  # You may or may not want to provide this to your production server...
  config.management_token = ENV[&#39;CONTENTFUL_MANAGEMENT_TOKEN&#39;] unless Rails.env.production?

  config.app_url = &quot;https://#{ENV[&#39;HOSTNAME&#39;]}&quot;
  config.webhook_username = &#39;my-app-webhook&#39;
  config.webhook_password = Rails.application.secrets.webhook_password
  config.webhook_jobs &lt;&lt; MyOnWebhookJob

  config.store = :lazy_sync, Rails.cache if Rails.env.production?
  # config.store = MyCustomStore.new

  # Use a custom Faraday connection
  config.connection = Faraday.new do |builder|
    f.request :retry
    f.request MyFaradayRequestAdapter.new
    ...
  end
  # OR implement some adapter like this to use another HTTP client
  config.connection = MyNetHttpAdapter.new

  config.update_schema_file = :never
end

WCC::Contentful.init!
</code></pre>

<p>For Heroku:</p>

<pre class="code yaml"><code class="yaml"># Procfile
web: bundle exec rails s
worker: bundle exec sidekiq
release: bin/release
</code></pre>

<pre class="code sh"><code class="sh"># bin/release
#!/bin/sh

set -e

echo &quot;Migrating database...&quot;
bin/rake db:migrate

echo &quot;Migrating contentful...&quot;
migrations_to_be_run=$( ... ) # somehow figure this out
node_modules/.bin/contentful-migration \
    -s $CONTENTFUL_SPACE_ID -a $CONTENTFUL_MANAGEMENT_TOKEN \
    -y -p &quot;$migrations_to_be_run&quot;

echo &quot;Updating schema file...&quot;
rake wcc_contentful:download_schema
</code></pre>

<p>All configuration options can be found <a href="https://www.rubydoc.info/gems/wcc-contentful/WCC/Contentful/Configuration">in the rubydoc</a> under
<span class='object_link'><a href="WCC/Contentful/Configuration.html" title="WCC::Contentful::Configuration (class)">WCC::Contentful::Configuration</a></span></p>

<h2 id="connecting-to-multiple-spaces-or-environments">Connecting to multiple spaces or environments</h2>

<p>When initializing the WCC::Contentful gem using <code>WCC::Contentful.init!</code>, the gem will by default connect to the single
Contentful space that you specify in the <code>WCC::Contentful.configure</code> step.  However the gem is also capable of connecting
to multiple spaces within the same ruby process!  You just have to create and initialize a namespace.</p>

<p>The <span class='object_link'><a href="WCC/Contentful/ModelAPI.html" title="WCC::Contentful::ModelAPI (module)">WCC::Contentful::ModelAPI</a></span> concern makes this straightforward.  Start by creating your Namespace
and including the concern:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># lib/my_second_space.rb
</span>
<span class='comment'># Note: This class must be in the &quot;lib&quot; folder in :zeitwerk mode, otherwise Rails 6+ will unload all your constants
</span><span class='comment'># that were created in the initializer.  Your models which subclass this namespace may reside in the app/models directory.
</span><span class='kw'>class</span> <span class='const'>MySecondSpace</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="WCC.html" title="WCC (module)">WCC</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful.html" title="WCC::Contentful (module)">Contentful</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="WCC/Contentful/ModelAPI.html" title="WCC::Contentful::ModelAPI (module)">ModelAPI</a></span></span>
<span class='kw'>end</span>

<span class='comment'># app/models/other_page.rb
</span><span class='kw'>class</span> <span class='const'>OtherPage</span> <span class='op'>&lt;</span> <span class='const'>MySecondSpace</span><span class='op'>::</span><span class='const'>Page</span>
<span class='kw'>end</span>
</code></pre>

<p>Then configure it in an initializer:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># config/initializers/my_second_space.rb
</span><span class='const'>MySecondSpace</span><span class='period'>.</span><span class='id identifier rubyid_configure'>configure</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
  <span class='comment'># Make sure to point to a different schema file from your first space!
</span>  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_schema_file'>schema_file</span> <span class='op'>=</span> <span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_root'>root</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>db/second-contentful-schema.json</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_access_token'>access_token</span> <span class='op'>=</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SECOND_CONTENTFUL_ACCESS_TOKEN</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_preview_token'>preview_token</span> <span class='op'>=</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SECOND_CONTENTFUL_PREVIEW_ACCESS_TOKEN</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_space'>space</span> <span class='op'>=</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SECOND_CONTENTFUL_SPACE_ID</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_environment'>environment</span> <span class='op'>=</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>CONTENTFUL_ENVIRONMENT</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
<span class='kw'>end</span>

<span class='comment'># Ensure that models are reloaded in Rails development mode
</span><span class='const'>Rails</span><span class='period'>.</span><span class='id identifier rubyid_application'>application</span><span class='period'>.</span><span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_to_prepare'>to_prepare</span> <span class='kw'>do</span>
  <span class='const'>MySecondSpace</span><span class='period'>.</span><span class='id identifier rubyid_reload!'>reload!</span>
<span class='kw'>end</span>
</code></pre>

<p>Finally, use it:</p>

<pre class="code ruby"><code class="ruby"><span class='const'>OtherPage</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1234</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='comment'># GET https://cdn.contentful.com/spaces/other-space/environments/other-env/entries/1234
</span><span class='comment'># =&gt; #&lt;OtherPage:0x0000000005c71a78 @created_at=2018-04-16 18:41:17 UTC...&gt;
</span>
<span class='const'>Page</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>1234</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='comment'># GET https://cdn.contentful.com/spaces/first-space/environments/first-env/entries/1234
</span><span class='comment'># =&gt; #&lt;Page:0x0000000001271b70 @created_at=2018-04-15 12:02:14 UTC...&gt;
</span></code></pre>

<p>The ModelAPI defines a second stack of services that you can access for lower level connections:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_store'>store</span> <span class='op'>=</span> <span class='const'>MySecondSpace</span><span class='period'>.</span><span class='id identifier rubyid_services'>services</span><span class='period'>.</span><span class='id identifier rubyid_store'>store</span>
<span class='comment'># =&gt; #&lt;WCC::Contentful::Store::CDNAdapter:0x00007f888edac118
</span><span class='id identifier rubyid_client'>client</span> <span class='op'>=</span> <span class='const'>MySecondSpace</span><span class='period'>.</span><span class='id identifier rubyid_services'>services</span><span class='period'>.</span><span class='id identifier rubyid_client'>client</span>
<span class='comment'># =&gt; #&lt;WCC::Contentful::SimpleClient::Cdn:0x00007f88942a8888
</span><span class='id identifier rubyid_preview_client'>preview_client</span> <span class='op'>=</span> <span class='const'>MySecondSpace</span><span class='period'>.</span><span class='id identifier rubyid_services'>services</span><span class='period'>.</span><span class='id identifier rubyid_preview_client'>preview_client</span>
<span class='comment'># =&gt; #&lt;WCC::Contentful::SimpleClient::Preview:0x00007f888ccafa00
</span><span class='id identifier rubyid_sync_engine'>sync_engine</span> <span class='op'>=</span> <span class='const'>MySecondSpace</span><span class='period'>.</span><span class='id identifier rubyid_services'>services</span><span class='period'>.</span><span class='id identifier rubyid_sync_engine'>sync_engine</span>
<span class='comment'># =&gt; #&lt;WCC::Contentful::SyncEngine:0x00007f88960b6b40
</span></code></pre>

<p>Note that the above services are not accessible on <span class='object_link'><a href="WCC/Contentful/Services.html#instance-class_method" title="WCC::Contentful::Services.instance (method)">WCC::Contentful::Services.instance</a></span>
or via the <span class='object_link'><a href="WCC/Contentful/ServiceAccessors.html" title="WCC::Contentful::ServiceAccessors (module)">WCC::Contentful::ServiceAccessors</a></span>.</p>

<h4 id="important-note-when-using-zeitwerk-with-rails-6">Important Note when using Zeitwerk with Rails 6+</h4>

<p>When using Rails &gt;= 6 with <code>config.autoloader = :zeitwerk</code>, Rails will remove any models defined in <code>app/models</code> after
initialization and then load them again when they are referenced.  If you <code>include WCC::Contentful::ModelAPI</code> in a class
defined inside the <code>app</code> directory, this will have the effect of deleting all configuration that was set in the initializer
as well as the constants generated from your schema.
This will result in one of two errors:</p>

<ul>
<li><code>NameError (uninitialized constant MySecondSpace::MyContentType)</code><br>
if you try to reference a subclass such as <code>MyContentType &lt; MySecondSpace::MyContentType</code></li>
<li><code>ArgumentError (Not yet configured!)</code>
if you try to <code>MySecondSpace.find(&#39;xxxx&#39;)</code> to load an Entry or Asset</li>
</ul>

<p>The solution is to have your secondary namespace in a folder which is not in the <code>autoload_paths</code>.
We suggest using <code>lib</code>, which will work so long as you have not added the <code>lib</code> folder to the <code>autoload_paths</code> as some
uninformed StackOverflow answers suggest you do.</p>

<h3 id="using-a-sync-store-with-a-second-space">Using a sync store with a second space</h3>

<p>If you use something other than the CDNAdapter with your second space, you will
need to find a way to trigger <code>MySecondSpace.services.sync_engine.next</code> to keep
it up-to-date.  The <span class='object_link'><a href="WCC/Contentful/Engine.html" title="WCC::Contentful::Engine (class)">WCC::Contentful::Engine</a></span> will only manage the global SyncEngine
configured by the global <span class='object_link'><a href="WCC/Contentful.html#configure-class_method" title="WCC::Contentful.configure (method)">WCC::Contentful.configure</a></span>.</p>

<p>The easiest way to do this is to set up your own Rails route to respond to Contentful
webhooks and then configure the second Contentful space to send webhooks to this route.
You could also do this by triggering it periodically in a background job using
Sidekiq and <a href="https://github.com/Moove-it/sidekiq-scheduler">sidekiq-scheduler</a>.</p>

<h2 id="development">Development</h2>

<p>After checking out the repo, run <code>bin/setup</code> to install dependencies. Then, run <code>bundle exec rspec</code> to run the tests. You can also run <code>bin/console</code> for an interactive prompt that will allow you to experiment.</p>

<h2 id="contributing">Contributing</h2>

<p>Bug reports and pull requests are welcome on GitHub at <a href="https://github.com/watermarkchurch/wcc-contentful">https://github.com/watermarkchurch/wcc-contentful</a>.</p>

<p>The developers at Watermark Community Church have pledged to govern their interactions with each other, with their clients, and with the larger wcc-contentful user community in accordance with the &quot;instruments of good works&quot; from chapter 4 of The Rule of St. Benedict (hereafter: &quot;The Rule&quot;). This code of ethics has proven its mettle in thousands of diverse communities for over 1,500 years, and has served as a baseline for many civil law codes since the time of Charlemagne.</p>

<p><a href="https://github.com/watermarkchurch/wcc-contentful/blob/master/CODE_OF_ETHICS.md">See the full Code of Ethics</a></p>

<h2 id="license">License</h2>

<p>The gem is available as open source under the terms of the <a href="http://opensource.org/licenses/MIT">MIT License</a>.</p>
</div></div>

      <div id="footer">
  
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.28 (ruby-3.1.1).
</div>

    </div>
  </body>
</html>