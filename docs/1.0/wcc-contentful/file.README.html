<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Documentation by YARD 0.9.26
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "README";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><p><a href="https://rubygems.org/gems/wcc-contentful"><img src="https://badge.fury.io/rb/wcc-contentful.svg" alt="Gem Version" /></a>
<a href="https://travis-ci.org/watermarkchurch/wcc-contentful"><img src="https://travis-ci.org/watermarkchurch/wcc-contentful.svg?branch=master" alt="Build Status" /></a>
<a href="https://coveralls.io/github/watermarkchurch/wcc-contentful?branch=master"><img src="https://coveralls.io/repos/github/watermarkchurch/wcc-contentful/badge.svg?branch=master" alt="Coverage Status" /></a></p>

<p>Full documentation: https://www.rubydoc.info/gems/wcc-contentful</p>

<h1 id="wcccontentful">WCC::Contentful</h1>

<h2 id="installation">Installation</h2>

<p>Add this line to your application’s Gemfile:</p>

<p><code>ruby
gem 'wcc-contentful', require: 'wcc/contentful/rails'
</code></p>

<p>If you’re not using rails, exclude the <code>require:</code> parameter.</p>

<p><code>ruby
gem 'wcc-contentful'
</code></p>

<p>And then execute:
<code>
    $ bundle
</code>
Or install it yourself as:
<code>
    $ gem install wcc-contentful
</code></p>

<h2 id="configure">Configure</h2>

<p>Put this in an initializer:
```ruby
# config/initializers/wcc_contentful.rb
WCC::Contentful.configure do |config|
  config.access_token = <CONTENTFUL_ACCESS_TOKEN>
  config.space = <CONTENTFUL_SPACE_ID>
end</CONTENTFUL_SPACE_ID></CONTENTFUL_ACCESS_TOKEN></p>

<p>WCC::Contentful.init!
```</p>

<p>All configuration options can be found <a href="https://www.rubydoc.info/gems/wcc-contentful/WCC/Contentful/Configuration">in the rubydoc</a> under
<span class='object_link'><a href="WCC/Contentful/Configuration.html" title="WCC::Contentful::Configuration (class)">WCC::Contentful::Configuration</a></span></p>

<h2 id="usage">Usage</h2>

<h3 id="wcccontentfulmodel-api">WCC::Contentful::Model API</h3>

<p>The WCC::Contentful::Model API exposes Contentful data as a set of dynamically
generated Ruby objects.  These objects are based on the content types in your
Contentful space.  All these objects are generated by <code>WCC::Contentful.init!</code></p>

<p>The following examples show how to use this API to find entries of the <code>page</code>
content type:</p>

<p>```ruby
# Find objects by id
WCC::Contentful::Model::Page.find(‘1E2ucWSdacxxf233sfa3’)
# =&gt; #&lt;WCC::Contentful::Model::Page:0x0000000005c71a78 @created_at=2018-04-16 18:41:17 UTC…&gt;</p>

<h1 id="find-objects-by-field">Find objects by field</h1>
<p>WCC::Contentful::Model::Page.find_by(slug: ‘/some-slug’)
# =&gt; #&lt;WCC::Contentful::Model::Page:0x0000000005c71a78 @created_at=2018-04-16 18:41:17 UTC…&gt;</p>

<h1 id="use-operators-to-filter-by-a-field">Use operators to filter by a field</h1>
<p># must use full notation for sys attributes (except ID)
WCC::Contentful::Model::Page.find_all(‘sys.created_at’ =&gt; { lte: Date.today })
# =&gt; [#&lt;WCC::Contentful::Model::Page:0x0000000005c71a78 @created_at=2018-04-16 18:41:17 UTC…&gt;, … ]</p>

<h1 id="nest-queries-to-mimick-joins">Nest queries to mimick joins</h1>
<p>WCC::Contentful::Model::Page.find_by(subpages: { slug: ‘/some-slug’ })
# =&gt; #&lt;WCC::Contentful::Model::Page:0x0000000005c71a78 @created_at=2018-04-16 18:41:17 UTC…&gt;</p>

<h1 id="pass-the-preview-flag-to-use-the-preview-client-must-have-set-previewtoken-config-param">Pass the preview flag to use the preview client (must have set preview_token config param)</h1>
<p>preview_redirect = WCC::Contentful::Model::Redirect.find_by({ slug: ‘draft-redirect’ }, preview: true)
# =&gt; #&lt;WCC::Contentful::Model::Redirect:0x0000000005d879ad @created_at=2018-04-16 18:41:17 UTC…&gt;
preview_redirect_object.href
# =&gt; ‘http://www.somesite.com/slug-for-redirect’
```</p>

<p>See the <span class='object_link'><a href="WCC/Contentful/Model.html" title="WCC::Contentful::Model (class)">WCC::Contentful::Model</a></span> documentation for more details.</p>

<h3 id="store-api">Store API</h3>

<p>The Store layer is used by the Model API to access Contentful data in a raw form.
The Store layer returns entries as hashes parsed from JSON, conforming to the
object structure returned from the Contentful CDN.</p>

<p>The following examples show how to use the Store API to retrieve raw data from
the store:</p>

<p>```ruby
store = WCC::Contentful::Services.instance.store
# =&gt; #&lt;WCC::Contentful::Store::CDNAdapter:0x00007fb92a221498</p>

<p>store.find(‘5FsqsbMECsM62e04U8sY4Y’)
# =&gt; #  …
# “fields”=&gt;
# …</p>

<p>store.find_by(content_type: ‘page’, filter: { slug: ‘/some-slug’ })
# =&gt; #  …
# “fields”=&gt;
# …</p>

<p>query = store.find_all(content_type: ‘page’).eq(‘group’, ‘some-group’)
# =&gt; #&lt;WCC::Contentful::Store::CDNAdapter::Query:0x00007fa3d40b84f0
query.first
# =&gt; #  …
# “fields”=&gt;
# …
query.result
# =&gt; #&lt;Enumerator::Lazy: …&gt;
query.result.force
# =&gt; […, …, …]
```</p>

<p>See the <span class='object_link'><a href="WCC/Contentful/Store.html" title="WCC::Contentful::Store (module)">WCC::Contentful::Store</a></span> documentation for more details.</p>

<h3 id="direct-cdn-api-simpleclient">Direct CDN API (SimpleClient)</h3>

<p>The SimpleClient is the bottom layer, and is used to get raw data directly from
the Contentful CDN.  It handles response parsing and paging, but does not resolve
links or transform the result into a Model class.</p>

<p>The following examples show how to use the SimpleClient to retrieve data directly
from the Contentful CDN:</p>

<p>```ruby
client = WCC::Contentful::Services.instance.client
# =&gt; #&lt;WCC::Contentful::SimpleClient::Cdn:0x00007fa3cde89310</p>

<p>response = client.entry(‘5FsqsbMECsM62e04U8sY4Y’)
# =&gt; #&lt;WCC::Contentful::SimpleClient::Response:0x00007fa3d103a4e0
response.body
# =&gt; “ "sys": {\n …
response.raw
# =&gt; {“sys”=&gt;
#  …
# “fields”=&gt;
# …</p>

<p>client.asset(‘5FsqsbMECsM62e04U8sY4Y’).raw
# =&gt; #  …
# “fields”=&gt;
# …</p>

<p>response = client.entries(‘fields.group’ =&gt; ‘some-group’, ‘limit’ =&gt; 5)
# =&gt; #&lt;WCC::Contentful::SimpleClient::Response:0x00007fa3d103a4e0
response.count
# =&gt; 99
response.first
# =&gt; #  …
# “fields”=&gt;
# …
response.items
=&gt; #&lt;Enumerator::Lazy: …&gt;
response.items.count  # Careful! This evaluates the lazy iterator and gets all pages
# =&gt; 99</p>

<p>response.includes
# =&gt; #   {“sys”=&gt; …
#  “6Fwukxxkxa6qQCC04WCaqg”=&gt;
#   …
#   …}
```</p>

<p>The client handles Paging automatically within the lazy iterator returned by #items.
This lazy iterator does not respect the <code>limit</code> param - that param is only passed
through to the API to set the page size.  If you truly want a limited subset of
response items, use <a href="https://ruby-doc.org/core-2.5.3/Enumerable.html#method-i-take"><code>response.items.take(n)</code></a></p>

<p>Entries included via the <code>include</code> parameter are made available on the #includes
field.  This is a hash of <code>&lt;entry ID&gt; =&gt; &lt;raw entry&gt;</code> and makes it easy to grab
links.  This hash is added to lazily as you enumerate the pages.</p>

<p>See the <span class='object_link'><a href="WCC/Contentful/SimpleClient.html" title="WCC::Contentful::SimpleClient (class)">WCC::Contentful::SimpleClient</a></span> documentation for more details.</p>

<h3 id="accessing-the-apis-within-application-code">Accessing the APIs within application code</h3>

<p>The Model API is best exposed by defining your own model classes in the <code>app/models</code>
directory which inherit from the WCC::Contentful models.</p>

<p>```ruby
# app/models/page.rb
class Page &lt; WCC::Contentful::Model::Page</p>

<p># You can add additional methods here
end</p>

<h1 id="appcontrollerspagescontrollerrb">app/controllers/pages_controller.rb</h1>
<p>class PagesController &lt; ApplicationController
  def show
    @page = Page.find_by(slug: params[:slug])
    raise Exceptions::PageNotFoundError, params[:slug] unless @page
  end
end
```</p>

<p>The <span class='object_link'><a href="WCC/Contentful/Services.html" title="WCC::Contentful::Services (class)">WCC::Contentful::Services</a></span> singleton gives access to the other configured services.
You can also include the <span class='object_link'><a href="WCC/Contentful/ServiceAccessors.html" title="WCC::Contentful::ServiceAccessors (module)">WCC::Contentful::ServiceAccessors</a></span> concern to define these
services as attributes in a class.</p>

<p>```ruby
class MyJob &lt; ApplicationJob
  include WCC::Contentful::ServiceAccessors</p>

<p>def perform
    Page.find(…)</p>

<pre class="code ruby"><code class="ruby">store.find(...)

client.entries(...)   end end ```
</code></pre>

<h2 id="architecture">Architecture</h2>

<p><img src="./doc/wcc-contentful.png" alt="wcc-contentful diagram" /></p>

<h2 id="test-helpers">Test Helpers</h2>

<p>To use the test helpers, include the following in your rails_helper.rb:</p>

<p><code>ruby
require 'wcc/contentful/rspec'
</code></p>

<p>This adds the following helpers to all your specs:</p>

<p>```ruby
##
# Builds a in-memory instance of the Contentful model for the given content_type.
# All attributes that are known to be required fields on the content type
# will return a default value based on the field type.
instance = contentful_create(‘my-content-type’, my_field: ‘some-value’)
# =&gt; #&lt;WCC::Contentful::Model::MyContentType:0x0000000005c71a78 @created_at=2018-04-16 18:41:17 UTC…&gt;</p>

<p>instance.my_field
# =&gt; “some-value”</p>

<p>instance.other_required_field
# =&gt; “default-value”</p>

<p>instance.other_optional_field
# =&gt; nil</p>

<p>instance.not_a_field
# NoMethodError: undefined method `not_a_field’ for #<MyContentType:0x00007fbac81ee490></MyContentType:0x00007fbac81ee490></p>

<h2 id="builds-a-rspec-double-of-the-contentful-model-for-the-given-contenttype">
# Builds a rspec double of the Contentful model for the given content_type.</h2>
<p># All attributes that are known to be required fields on the content type
# will return a default value based on the field type.
dbl = contentful_double(‘my-content-type’, my_field: ‘other-value’)
# =&gt; #&lt;Double (anonymous)&gt;</p>

<p>dbl.my_field
# =&gt; “other-value”</p>

<p>dbl.other_optional_field
# =&gt; nil</p>

<p>dbl.not_a_field
# =&gt; #&lt;Double (anonymous)&gt; received unexpected message :not_a_field with (no args)</p>

<h2 id="builds-out-a-fake-contentful-entry-for-the-given-content-type-and-then">
# Builds out a fake Contentful entry for the given content type, and then</h2>
<p># stubs the Model API to return that content type for <code>.find</code> and <code>.find_by</code>
# query methods.
stubbed = contentful_stub(‘my-content-type’, id: ‘1234’, my_field: ‘test’)</p>

<p>WCC::Contentful::Model.find(‘1234’) == stubbed
# =&gt; true</p>

<p>MyContentType.find(‘1234’) == stubbed
# =&gt; true</p>

<p>MyContentType.find_by(my_field: ‘test’) == stubbed
# =&gt; true
```</p>

<h2 id="advanced-configuration-example">Advanced Configuration Example</h2>

<p>Here’s an example containing all the configuration options, and a sample setup for
automatic deployment to Heroku.  This is intended to make you aware of what is possible,
and not as a general recommendation of what your setup should look like.</p>

<p>```ruby
# config/initializers/wcc_contentful.rb
WCC::Contentful.configure do |config|
  config.access_token = ENV[‘CONTENTFUL_ACCESS_TOKEN’]
  config.space = ENV[‘CONTENTFUL_SPACE_ID’]
  config.environment = ENV[‘CONTENTFUL_ENVIRONMENT’]
  config.preview_token = ENV[‘CONTENTFUL_PREVIEW_ACCESS_TOKEN’]</p>

<p># You may or may not want to provide this to your production server…
  config.management_token = ENV[‘CONTENTFUL_MANAGEMENT_TOKEN’] unless Rails.env.production?</p>

<p>config.app_url = “https://#ENV[‘HOSTNAME’]”
  config.webhook_username = ‘my-app-webhook’
  config.webhook_password = Rails.application.secrets.webhook_password
  config.webhook_jobs « MyOnWebhookJob</p>

<p>config.store = :lazy_sync, Rails.cache if Rails.env.production?
  # config.store = MyCustomStore.new</p>

<p># Use a custom Faraday connection
  config.connection = Faraday.new do |builder|
    f.request :retry
    f.request MyFaradayRequestAdapter.new
    …
  end
  # OR implement some adapter like this to use another HTTP client
  config.connection = MyNetHttpAdapter.new</p>

<p>config.update_schema_file = :never
end</p>

<p>WCC::Contentful.init!
```</p>

<p>For Heroku:</p>

<p><code>yaml
# Procfile
web: bundle exec rails s
worker: bundle exec sidekiq
release: bin/release
</code></p>

<p>```sh
# bin/release
#!/bin/sh</p>

<p>set -e</p>

<p>echo “Migrating database…”
bin/rake db:migrate</p>

<p>echo “Migrating contentful…”
migrations_to_be_run=$( … ) # somehow figure this out
node_modules/.bin/contentful-migration \
    -s $CONTENTFUL_SPACE_ID -a $CONTENTFUL_MANAGEMENT_TOKEN \
    -y -p “$migrations_to_be_run”</p>

<p>echo “Updating schema file…”
rake wcc_contentful:download_schema
```</p>

<p>All configuration options can be found <a href="https://www.rubydoc.info/gems/wcc-contentful/WCC/Contentful/Configuration">in the rubydoc</a> under
<span class='object_link'><a href="WCC/Contentful/Configuration.html" title="WCC::Contentful::Configuration (class)">WCC::Contentful::Configuration</a></span></p>

<h2 id="development">Development</h2>

<p>After checking out the repo, run <code>bin/setup</code> to install dependencies. Then, run <code>bundle exec rspec</code> to run the tests. You can also run <code>bin/console</code> for an interactive prompt that will allow you to experiment.</p>

<h2 id="contributing">Contributing</h2>

<p>Bug reports and pull requests are welcome on GitHub at https://github.com/watermarkchurch/wcc-contentful. This project is intended to be a safe, welcoming space for collaboration, and contributors are expected to adhere to the <a href="http://contributor-covenant.org">Contributor Covenant</a> code of conduct.</p>

<h2 id="license">License</h2>

<p>The gem is available as open source under the terms of the <a href="http://opensource.org/licenses/MIT">MIT License</a>.</p>

<h2 id="code-of-conduct">Code of Conduct</h2>

<p>Everyone interacting in the WCC::Contentful project’s codebases, issue trackers, chat rooms and mailing lists is expected to follow the <a href="https://github.com/watermarkchurch/wcc-contentful/blob/master/CODE_OF_CONDUCT.md">code of conduct</a>.</p>
</div></div>

      <div id="footer">
  
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.26 (ruby-2.5.7).
</div>

    </div>
  </body>
</html>
